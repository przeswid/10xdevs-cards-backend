<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <!-- 
    AI_GENERATION_SESSIONS TABLE CREATION
    ======================================
    
    PURPOSE: Track AI flashcard generation requests for analytics and cost monitoring
    BUSINESS CONTEXT: Enable AI usage analytics, cost tracking, and generation effectiveness measurement
    
    DESIGN DECISIONS:
    - UUID primary key for session identification
    - Input text validation (1000-10000 chars as per PRD)
    - Status tracking for generation workflow
    - Cost tracking for budget management
    - Model tracking for quality analysis
    
    DEPENDENCIES: users table (foreign key reference)
    -->

    <changeSet id="create-table-ai-generation-sessions" author="migration-team" context="core">
        <preConditions onFail="HALT">
            <tableExists tableName="users"/>
        </preConditions>
        
        <comment>Create ai_generation_sessions table for tracking AI flashcard generation analytics</comment>

        <createTable tableName="ai_generation_sessions" 
                     remarks="Tracks AI flashcard generation sessions with analytics and cost data">
            <column name="id" type="UUID" remarks="Primary key - unique session identifier">
                <constraints primaryKey="true" primaryKeyName="pk_ai_generation_sessions"/>
            </column>
            
            <column name="user_id" type="UUID" remarks="Foreign key to users table - session owner">
                <constraints nullable="false"/>
            </column>
            
            <column name="input_text" type="TEXT" 
                    remarks="Original text input for AI generation (1000-10000 characters)">
                <constraints nullable="false"/>
            </column>
            
            <column name="generated_count" type="INTEGER" 
                    remarks="Number of flashcards generated by AI" 
                    defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <column name="accepted_count" type="INTEGER" 
                    remarks="Number of generated flashcards accepted by user" 
                    defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <column name="ai_model" type="VARCHAR(50)" 
                    remarks="AI model used for generation (e.g., gpt-4, claude-3)"/>
            
            <column name="api_cost" type="DECIMAL(10,4)" 
                    remarks="API cost in USD for this generation session"/>
            
            <column name="status" type="VARCHAR(20)" 
                    remarks="Session status: PENDING, COMPLETED, FAILED" 
                    defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" 
                    remarks="Session creation timestamp" 
                    defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <rollback>
            <dropTable tableName="ai_generation_sessions"/>
        </rollback>
    </changeSet>

    <changeSet id="add-check-constraints-ai-generation-sessions" author="migration-team" context="core">
        <preConditions onFail="HALT">
            <tableExists tableName="ai_generation_sessions"/>
        </preConditions>
        
        <comment>Add CHECK constraints for ai_generation_sessions data validation</comment>

        <sql>
            <![CDATA[
            ALTER TABLE ai_generation_sessions ADD CONSTRAINT ck_ai_sessions_input_length 
            CHECK (LENGTH(input_text) >= 1000 AND LENGTH(input_text) <= 10000);
            
            ALTER TABLE ai_generation_sessions ADD CONSTRAINT ck_ai_sessions_status_valid 
            CHECK (status IN ('PENDING', 'COMPLETED', 'FAILED'));
            
            ALTER TABLE ai_generation_sessions ADD CONSTRAINT ck_ai_sessions_generated_count_non_negative 
            CHECK (generated_count >= 0);
            
            ALTER TABLE ai_generation_sessions ADD CONSTRAINT ck_ai_sessions_accepted_count_non_negative 
            CHECK (accepted_count >= 0);
            
            ALTER TABLE ai_generation_sessions ADD CONSTRAINT ck_ai_sessions_api_cost_non_negative 
            CHECK (api_cost IS NULL OR api_cost >= 0);
            ]]>
        </sql>

        <rollback>
            <sql>
                <![CDATA[
                ALTER TABLE ai_generation_sessions DROP CONSTRAINT IF EXISTS ck_ai_sessions_input_length;
                ALTER TABLE ai_generation_sessions DROP CONSTRAINT IF EXISTS ck_ai_sessions_status_valid;
                ALTER TABLE ai_generation_sessions DROP CONSTRAINT IF EXISTS ck_ai_sessions_generated_count_non_negative;
                ALTER TABLE ai_generation_sessions DROP CONSTRAINT IF EXISTS ck_ai_sessions_accepted_count_non_negative;
                ALTER TABLE ai_generation_sessions DROP CONSTRAINT IF EXISTS ck_ai_sessions_api_cost_non_negative;
                ]]>
            </sql>
        </rollback>
    </changeSet>

    <!-- 
    BUSINESS RULES:
    1. Input text must be between 1000-10000 characters (PRD requirement)
    2. Generated and accepted counts cannot be negative
    3. Status must be one of: PENDING, COMPLETED, FAILED
    4. API cost, if specified, must be non-negative
    5. AI model is optional (for backward compatibility)
    
    ANALYTICS USE CASES:
    - Track AI generation success rate (accepted_count / generated_count)
    - Monitor API costs per user and per model
    - Analyze most effective AI models
    - Identify users with high/low acceptance rates
    - Track generation volume over time
    -->

</databaseChangeLog>